"use strict";var app=angular.module("midotApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","times.tabletop"]);app.config(["TabletopProvider",function(a){a.setTabletopOptions({key:"https://docs.google.com/spreadsheets/d/1tZL7qG6Ysbv_nB0XZR487pBKwKvGdGAv1ObaYPwqf8U/pubhtml?gid=1195003145&single=true"})}]),angular.module("midotApp").controller("MainCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("midotApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("midotApp").factory("rows",["Tabletop","$q","$window",function(a,b,c){return b(function(b){c.localStorage&&c.localStorage.data&&c.localStorage.date+36e5>Date.now()?b(JSON.parse(c.localStorage.data)):a.then(function(a){var d={amutot:a[0].amutot.elements.slice(1),columns:a[0].amutot.column_names,headers:a[0].amutot.elements[0],subjects:_.object(_.map(a[0].subjects.elements,function(a){return[a.subject.trim(),a.text]}))};d.headers=_.map(a[0].amutot.column_names,function(a){return d.headers[a]}),d.amutot=_.map(d.amutot,function(a){return a=_.mapObject(a,function(a){return a=a.trim(),""===a&&(a=null),"√"===a&&(a="קיים"),"X"===a&&(a="אין"),a}),a.age=parseInt(a.age),a.found_year=parseInt(a.found_year),a.reg_year=parseInt(a.reg_year),a.year=a.reg_year?a.found_year&&a.found_year<a.reg_year?a.found_year:a.reg_year:a.found_year?a.found_year:null,a}),c.localStorage&&(c.localStorage.data=JSON.stringify(d),c.localStorage.date=Date.now()),b(d)})})}]),angular.module("midotApp").controller("MainpageCtrl",["rows","$scope","$filter",function(a,b,c){function d(a,b){var c=_.countBy(a,b),d=d3.sum(_.values(c));return c=_.sortBy(_.pairs(c),function(a){return-a[1]}),_.forEach(c,function(a,c){a[0]=a[0].replace("בין ","").replace(new RegExp(" מיליון","g"),"M"),a.push(100*a[1]/d),a.push(b),a.push(c)}),c=_.filter(c,function(a){return null!==a[0]})}function e(){var a=c("filter")(f.rows,b.query),e={};b.selectedSector&&(a=c("fieldFilter")(a,"sector",b.selectedSector.sector)),b.minVolume>=0&&b.maxVolume>=0&&(a=c("fieldRangeFilter")(a,"volume_2013",b.minVolume,b.maxVolume)),b.selectedLocationArea&&(a=c("fieldFilter")(a,"location_area",b.selectedLocationArea.location_area)),b.selectedOperationField&&(a=c("fieldFilter")(a,["operation_field","operation_field_2"],b.selectedOperationField)),f.filteredRows=a,b.selectedSector||(e["סיווג ענפי"]=d(a,"sector")),b.selectedVolume2013Granular||(e["מחזור כספי"]=d(a,"volume_2013_granular")),b.selectedSector&&!b.selectedOperationField&&(e["תחום פעולה"]=d(a,"operation_field")),b.selectedStat&&b.selectedStat in e||(b.selectedStat=_.keys(e)[0]),f.stats=e,window.setTimeout(function(){for(var a=$($(".table tr")[2]).find("td"),b=$(".table th"),c=0;c<a.length;c++)$(b[c]).width($(a[c]).width());window.setTimeout(function(){var a=$($(".table thead tr")[0]).height();$($(".table td div")[0]).height(a-16)})},0),f.updatePie||(f.updatePie=f.drawPie()),f.updatePie(e[b.selectedStat])}var f=this;this.selectedRow=null,this.rows=[],this.updatePie=null,a.then(function(a){f.rows=a.amutot,f.columns=a.columns,f.headers=a.headers,f.rows=a.amutot,f.subjects=a.subjects,f.stats={},f.operation_fields=_.sortBy(_.union(_.map(f.rows,function(a){return a.operation_field}),_.map(f.rows,function(a){return a.operation_field_2})),function(a){return a}),f.operation_fields=_.filter(f.operation_fields,function(a){return null!==a}),e()}),b.$watchGroup(["query","selectedSector","minVolume","maxVolume","selectedLocationArea","selectedOperationField"],function(){e()}),b.$watchGroup(["selectedStat"],function(){console.log("selectedStat changed!"),f.updatePie&&f.updatePie(f.stats[b.selectedStat])}),b.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},this.onClick=function(a){b.selectedRow=b.selectedRow===a?null:a},$(function(){$("[data-clampedwidth]").each(function(){var a=$(this),b=a.data("clampedwidth"),c=function(){var c=$(b).width();a.css("width",c)};c(),$(window).resize(c)}),f.volumeSlider=new Slider("#volume2013GranularSlider"),f.volumeSlider.on("slide",function(){var a=f.volumeSlider.getValue(),c={8:["0",0],7:["מיליון",1e6],6:["5 מיליון",5e6],5:["10 מיליון",1e7],4:["25 מיליון",25e6],3:["50 מיליון",5e7],2:["100 מיליון",1e8],1:["500 מיליון",5e8],0:["מיליארד",1e9]};f.minVolumeLabel=c[a[1]][0],f.maxVolumeLabel=c[a[0]][0],b.minVolume=c[a[1]][1],b.maxVolume=c[a[0]][1],b.$apply()}),f.volumeSlider._trigger("slide")}),this.downloadData=function(a){var b=_.map(a,function(a){return _.map(f.columns,function(b){return a[b]})});b.unshift(f.headers);for(var c=windows1255.encode(Papa.unparse(b),{mode:"html"}),d=new ArrayBuffer(c.length),e=new Uint8Array(d),g=0,h=c.length;h>g;g++)e[g]=c.charCodeAt(g);var i=new Blob([d],{type:"text/csv"}),j=URL.createObjectURL(i),k=document.createElement("a");k.download="midot-dataset.csv",k.href=j,k.click()},this.drawPie=function(){function a(a){var b=j.selectAll("path.arc").data(h(a));b.exit().remove(),b.enter().append("path").attr("class","arc").on("mouseover",l.show).on("mouseout",l.hide),b.attr("d",f).style("fill",function(a){return e(a.data[4])});var c=k.selectAll("text.arc").data(h(a));c.exit().remove(),c.enter().append("text").attr("class","arc").style("text-anchor","middle").style("pointer-events","none"),c.attr("transform",function(a){return"translate("+g.centroid(a)+")"}).text(function(a){return a.endAngle-a.startAngle>.5?a.data[0]:""})}var b=220,c=220,d=Math.min(b,c)/2,e=d3.scale.category20(),f=d3.svg.arc().outerRadius(d-10).innerRadius(0),g=d3.svg.arc().outerRadius(d-40).innerRadius(d-40),h=d3.layout.pie().sort(null).value(function(a){return a[1]}),i=d3.select("#pieChart").append("svg").attr("width",b).attr("height",c).append("g").attr("transform","translate("+b/2+","+c/2+")"),j=i.append("g"),k=i.append("g"),l=d3.tip().attr("class","d3-tip").html(function(a){return a.data[0]+"&rlm; - "+Math.round(a.data[2])+"%"});return i.call(l),a}}]),angular.module("midotApp").filter("unique",function(){function a(a,b){var c=a[b];if("volume_2013_granular"!==b)return c;if(c.startsWith("בין")){try{c=parseInt(c.split(" ")[1])}catch(d){c=-1}isNaN(c)&&(c=-1)}else c=-1;return c}return function(b,c){return c?_.sortBy(_.uniq(b,!1,function(a){return a[c]}),function(b){return a(b,c)}):_.sortBy(_.uniq(b,!1),function(a){return a})}}),angular.module("midotApp").filter("fieldFilter",function(){return function(a,b,c){return c?b.constructor===Array?_.filter(a,function(a){return _.some(b,function(b){return a[b]===c})}):_.filter(a,function(a){return a[b]===c}):a}}),angular.module("midotApp").filter("fieldRangeFilter",function(){return function(a,b,c,d){return _.filter(a,function(a){return a[b]>=c&&a[b]<=d})}}),angular.module("midotApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/main.html",'<div class="jumbotron"> <h1>\'Allo, \'Allo!</h1> <p class="lead"> <img src="images/yeoman.png" alt="I\'m Yeoman"><br> Always a pleasure scaffolding your apps. </p> <p><a class="btn btn-lg btn-success" ng-href="#/">Splendid!<span class="glyphicon glyphicon-ok"></span></a></p> </div> <div class="row marketing"> <h4>HTML5 Boilerplate</h4> <p> HTML5 Boilerplate is a professional front-end template for building fast, robust, and adaptable web apps or sites. </p> <h4>Angular</h4> <p> AngularJS is a toolset for building the framework most suited to your application development. </p> <h4>Karma</h4> <p>Spectacular Test Runner for JavaScript.</p> </div>')}]);